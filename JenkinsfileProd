pipeline {
  agent {
    label 'OmicronQA'
  }
  tools {
    maven 'M3'
    nodejs 'NodeJs12'
  }
  environment {
    //Functions
    DEPLOY_PATTERN = NewPatterName()

    // Projtect configurations
    COMPANY = "Omicron"
    COMPANY_LOWERCASE = "omicron"
    PROJECT_NAME = "AppiOSFormulas"
    PROJECT_NAME_LOWERCASE = "appiosformulas"
    SLACK_CHANNEL = "#omicron_notifications"
    ENVIRONMENT = "prod"
    ACR = "omicron.azurecr.io"
    REPOSITORY_NAME = "omicronprod"
    WEBCONFIGURATION = "production"

    // General configurations		
    SONAR_KEY = "20_OMICRONLAB_App-iOS-Formulas_UAT";
    SONAR_SERVER = "https://devtools.axity.com/sonarlts";
    SONAR_TOKEN = "d54f4f0b0ecc98ca94c88640833783fe52216269";
    COMMITER_EMAIL = sh(
      script: 'git --no-pager show -s --format=\'%an - %ae\'',
      returnStdout: true
    ).trim()
  }
  stages {
    stage('Docker Pull OracleJRE') {
      steps {
        withCredentials([
          [$class: 'UsernamePasswordMultiBinding', credentialsId: 'oracle_container_registry', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']
        ]) {
          sh 'docker login container-registry.oracle.com -u $USERNAME -p $PASSWORD'
          sh 'docker pull container-registry.oracle.com/java/serverjre:1.8.0_241-b07'
        }
      }
    }
    stage('Build Front Web') {
      when {
        anyOf {
          changeset "*frontend/web/**"
          expression {
            currentBuild.previousBuild.result != "SUCCESS"
          }
        }
      }
      steps {
        echo 'Building Frontend'
        dir('frontend/web/') {
          script {
            DockerBuildAndPush("web", "/")
          }
        }
      }
    }
    stage('Oauth') {
      when {
        anyOf {
          changeset "*services/oauthserver/**"
          expression {
            currentBuild.previousBuild.result != "SUCCESS"
          }
        }
      }
      steps {
        dir('services/oauthserver/') {
          script {
            DockerBuildAndPush("oauthserver", "")
          }
        }
      }
    }
    stage('Catalogos') {
      when {
        anyOf {
          changeset "*services/catalogos-service/**"
          expression {
            currentBuild.previousBuild.result != "SUCCESS"
          }
        }
      }
      steps {
        dir('services/catalogos-service/') {
          script {
            DockerBuildAndPush("catalogos", "")
          }
        }
      }
    }
    stage('Usuarios') {
      when {
        anyOf {
          changeset "*services/usuarios-service/**"
          expression {
            currentBuild.previousBuild.result != "SUCCESS"
          }
        }
      }
      steps {
        dir('services/usuarios-service/') {
          script {
            DockerBuildAndPush("usuarios", "")
          }
        }
      }
    }
    stage('Pedidos') {
      when {
        anyOf {
          changeset "*services/pedidos-service/**"
          expression {
            currentBuild.previousBuild.result != "SUCCESS"
          }
        }
      }
      steps {
        dir('services/pedidos-service/') {
          script {
            DockerBuildAndPush("pedidos", "")
          }
        }
      }
    }
    stage('SapAdapter') {
      when {
        anyOf {
          changeset "*services/sapadapter-service/**"
          expression {
            currentBuild.previousBuild.result != "SUCCESS"
          }
        }
      }
      steps {
        dir('services/sapadapter-service/') {
          script {
            DockerBuildAndPush("sapadapter", "")
          }
        }
      }
    }
    stage('Warehouse') {
      when {
        anyOf {
          changeset "*services/warehouses-service/**"
          expression {
            currentBuild.previousBuild.result != "SUCCESS"
          }
        }
      }
      steps {
        dir('services/warehouses-service/') {
          script {
            DockerBuildAndPush("warehouses", "")
          }
        }
      }
    }
    stage('Reporting') {
      when {
        anyOf {
          changeset "*services/reporting-service/**"
          expression {
            currentBuild.previousBuild.result != "SUCCESS"
          }
        }
      }
      steps {
        dir('services/reporting-service/') {
          script {
            DockerBuildAndPush("reporting", "")
          }
        }
      }
    }
    stage('Deploy App Service') {
      when {
        anyOf {
          changeset "*frontend/web/**"
          expression { currentBuild.previousBuild.result != "SUCCESS" }
        }
      }
      steps {
        azureWebAppPublish azureCredentialsId: 'Omicronapp', publishType: 'docker',
          resourceGroup: 'OmicronProduccion', appName: 'omicronlab',
          dockerImageName: 'omicron.azurecr.io/omicronprod/omicron-appiosformulas-web-repository', dockerImageTag: 'latest',
          dockerRegistryEndpoint: [credentialsId: 'omicronacr', url: 'https://omicron.azurecr.io'],
          skipDockerBuild: true
      }
    }
    stage('Kubernetes Up') {
      steps {
        dir('deploy/prod/'){
          echo 'Running Kubernetes'
          sh 'kubectl apply -f deploy_uat.yaml --context omicron-aks'
          sh 'kubectl apply -f ingress-oauth.yml --context omicron-aks'
          sh 'kubectl apply -f ingress-services.yml --context omicron-aks'
        }  
      }
    }
    stage('RollOut Oauth') {
      when {
        anyOf {
          changeset "*services/oauthserver/**"
          expression { currentBuild.previousBuild.result != "SUCCESS" }
        }
      }
      steps {
        echo 'Rollout Building Oaut'
        sh 'kubectl rollout restart deploy oauthserver-deployment --context omicron-aks'
      }
    }
    stage('RollOut Catalogos') {
      when {
        anyOf {
          changeset "*services/catalogos-service/**"
          expression { currentBuild.previousBuild.result != "SUCCESS" }
        }
      }
      steps {
        echo 'Rollout Building Catalogos'
        sh 'kubectl rollout restart deploy catalogos-deployment --context omicron-aks'
      }
    }
    stage('RollOut Usuarios') {
      when {
        anyOf {
          changeset "*services/usuarios-service/**"
          expression { currentBuild.previousBuild.result != "SUCCESS" }
        }
      }
      steps {
        echo 'Rollout Building Usuarios'
        sh 'kubectl rollout restart deploy usuarios-deployment --context omicron-aks'
      }
    }
    stage('RollOut Pedidos') {
      when {
        anyOf {
          changeset "*services/pedidos-service/**"
          expression { currentBuild.previousBuild.result != "SUCCESS" }
        }
      }
      steps {
        echo 'Rollout Building Pedidos'
        sh 'kubectl rollout restart deploy pedidos-deployment --context omicron-aks'
      }
    }
    stage('RollOut SapAdapter') {
      when {
        anyOf {
          changeset "*services/sapadapter-service/**"
          expression { currentBuild.previousBuild.result != "SUCCESS" }
        }
      }
      steps {
        echo 'Rollout Building SapAdapter'
        sh 'kubectl rollout restart deploy sapadapter-deployment --context omicron-aks'
      }
    }
    stage('RollOut Warehouse') {
      when {
        anyOf {
          changeset "*services/warehouses-service/**"
          expression { currentBuild.previousBuild.result != "SUCCESS" }
        }
      }
      steps {
        echo 'Rollout Building warehouse'
        sh 'kubectl rollout restart deploy warehouses-deployment --context omicron-aks'
      }
    }
    stage('RollOut Reporting') {
      when {
        anyOf {
          changeset "*services/reporting-service/**"
          expression { currentBuild.previousBuild.result != "SUCCESS" }
        }
      }
      steps {
        echo 'Rollout Building Reporting'
        sh 'kubectl rollout restart deploy reporting-deployment --context omicron-aks'
      }
    }
    stage('Database') {
      steps {
        dir('database/') {
          sh '/opt/liquibase/liquibase --version'
          sh '/opt/liquibase/liquibase --changeLogFile="changesets/db.changelog-master.xml" --defaultsFile="liquibase-prod.properties" update'
          echo 'Applying Db changes'
        }
      }
    }
    stage('Testing Estress') {
      steps {
        dir('testing/stress/') {
          echo 'Running Stress Testing'
        }
      }
    }
    stage('Testing UI') {
      steps {
        dir('testing/ui/') {
          echo 'Running UI Testing'
        }
      }
    }
    stage('Docker Clean') {
      steps {
        echo 'Cleaning Docker'
        sh "docker system prune -f -a"
      }
    }
  }
  post {
    always {
      deleteDir()
      echo 'Slack'
      SlackMsg(currentBuild.currentResult)
    }
    success {
      echo 'I succeeeded!'
    }
    unstable {
      echo 'I am unstable :/'
    }
    failure {
      echo 'I failed :('
    }
    changed {
      echo 'Things were different before...'
    }
  }
}

def NewPatterName() {
  return "_" + new Date().format('ddMMyyyy') + "_" + "${env.BUILD_NUMBER}";
}

def SlackMsg(String buildResult) {
  String message = "Compilation result ${env.BUILD_DISPLAY_NAME} for job  \"${env.JOB_NAME}\"  is " + buildResult + " launched by ${env.COMMITER_EMAIL}. For more details got to ${env.JOB_URL}"
  echo "${env.BUILD_DISPLAY_NAME}"

  if (buildResult == "SUCCESS") {
    slackSend channel: "${SLACK_CHANNEL}", color: "good", message: message
  } else if (buildResult == "UNSTABLE") {
    slackSend channel: "${SLACK_CHANNEL}", color: "warning", message: message
  } else {
    slackSend channel: "${SLACK_CHANNEL}", color: "danger", message: message
  }
}

def DockerBuildAndPush(entity, urlbase) {
  docker.withRegistry("https://${ACR}", "omicronacr") {
    docker.build("${ACR}/${REPOSITORY_NAME}/${COMPANY_LOWERCASE}-${PROJECT_NAME_LOWERCASE}-${entity}-repository:latest", "--build-arg BUILDKIT_INLINE_CACHE=1 --build-arg CONFIGURATION=${WEBCONFIGURATION} --build-arg BASE_HREF=${urlbase} --cache-from ${ACR}/${REPOSITORY_NAME}/${COMPANY_LOWERCASE}-${PROJECT_NAME_LOWERCASE}-${entity}-repository:latest .")
    docker.image("${ACR}/${REPOSITORY_NAME}/${COMPANY_LOWERCASE}-${PROJECT_NAME_LOWERCASE}-${entity}-repository:latest").push()
  }
}
