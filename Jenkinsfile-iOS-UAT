pipeline {
  agent {
    label 'macOS'
  }
  // tools {
  // }
  environment {
    //Functions
    DEPLOY_PATTERN = NewPatterName()

    // Projtect configurations
    COMPANY = 'Omicron'
    COMPANY_LOWERCASE = 'omicron'
    PROJECT_NAME = 'AppiOSFormulas'
    PROJECT_NAME_LOWERCASE = 'appiosformulas'
    SLACK_CHANNEL = '#omicron_notifications'
    ENVIRONMENT = 'UAT'
    APPCENTER_API_TOKEN = credentials('appcenter-omicron-almacen-prod')
    PUBLISH_APPCENTER = ''

    // General configurations
    COMMITER_EMAIL = sh(
      script: 'git --no-pager show -s --format=\'%an - %ae\'',
      returnStdout: true
    ).trim()
  }
  stages {
    stage('Get Publish') {
      steps {
        script {
          try {
            timeout(time:30, unit:'SECONDS') {
              PUBLISH_APPCENTER = input(
                message: 'Publish result to AppCenter?',
                parameters: [
                  [$class: 'ChoiceParameterDefinition',
                    choices: ['no', 'yes'].join('\n'),
                    name: 'input',
                    description: 'Select option'
                  ]
                ])
              echo "Publish AppCenter: ${PUBLISH_APPCENTER}"
            }
          } catch (err) {
            echo 'Response not recieved, skip publish...'
            PUBLISH_APPCENTER = 'no'
          }
        }
      }
    }
    stage('Build Front iOS') {
      steps {
        echo 'Building Frontend iOS'
        withCredentials([[$class: 'UsernamePasswordMultiBinding', credentialsId: 'macos-cred', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']]) {
          sh 'fastlane run unlock_keychain password:$PASSWORD'
        }
        dir('frontend/ios/') {
          sh 'fastlane archive_uat'
          archiveArtifacts 'output/*.*'
        }
      }
    }
    stage('Publish Front iOS App Center') {
      steps {
        script {
          if ("${PUBLISH_APPCENTER}" == 'yes') {
            echo 'Publish Frontend iOS'
            appCenter apiToken: APPCENTER_API_TOKEN,
              ownerName: 'ArquitecturaSWD',
              appName: 'Omicron-UAT-1',
              pathToApp: 'frontend/ios/output/Omicron-UAT.ipa',
              distributionGroups: 'public'
          } else {
            echo 'Not publishing...'
          }
        }
      }
    }
  }
  post {
    always {
      deleteDir()
      echo 'Slack'
      SlackMsg(currentBuild.currentResult)
    }
    success {
      echo 'I succeeeded!'
    }
    unstable {
      echo 'I am unstable :/'
    }
    failure {
      echo 'I failed :('
    }
    changed {
      echo 'Things were different before...'
    }
  }
}

def NewPatterName() {
  return '_' + new Date().format('ddMMyyyy') + '_' + "${env.BUILD_NUMBER}"
}

def SlackMsg(String buildResult) {
  String message = "Compilation result ${env.BUILD_DISPLAY_NAME} for job  \"${env.JOB_NAME}\"  is " + buildResult + " launched by ${env.COMMITER_EMAIL}. For more details got to ${env.JOB_URL}"
  echo "${env.BUILD_DISPLAY_NAME}"

  if (buildResult == 'SUCCESS') {
    slackSend channel: "${SLACK_CHANNEL}", color: 'good', message: message
  } else if (buildResult == 'UNSTABLE') {
    slackSend channel: "${SLACK_CHANNEL}", color: 'warning', message: message
  } else {
    slackSend channel: "${SLACK_CHANNEL}", color: 'danger', message: message
  }
}
