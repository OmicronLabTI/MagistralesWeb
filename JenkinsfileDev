pipeline {
    agent {
        label 'OmicronDev'
    }
    tools {
        maven 'M3'
        nodejs 'NodeJs12'
    }
    environment
	{
		//Functions
		DEPLOY_PATTERN = NewPatterName()

		// Paths to programas 
		//SONARQUBE_PATH = "H:\\Tools\\SonnarQube\\SonarScanner.MSBuild.exe";
		
		// Projtect configurations
        COMPANY = "Omicron"
        COMPANY_LOWERCASE = "omicron"
		PROJECT_NAME = "AppiOSFormulas"

		// General configurations		
		SONAR_KEY = "20_OMICRONLAB_App-iOS-Formulas_Dev";
		SONAR_SERVER = "https://devtools.axity.com/sonarlts";
		SONAR_TOKEN = "d54f4f0b0ecc98ca94c88640833783fe52216269";
	}
    stages {
        stage('Build Front Web') {
            steps {
                echo 'Building Frontend'
                dir ('frontend/web/'){
                    sh 'npm install'
					sh 'npm run build --prod'
					sh "docker build -f 'Dockerfile' -t ${COMPANY_LOWERCASE}-web-repository ."
                }
            }
        }
        stage('Build Federated Services') {
            steps {
                echo 'Building Fedetared Services'
                dir ('services/apimanager/'){
                    sh 'mvn clean package'
                    sh "docker build -f 'Dockerfile' -t ${COMPANY_LOWERCASE}-apimanager-repository ."
                }
                dir ('services/oauthserver/'){
                    sh 'mvn clean package'
                    sh "docker build -f 'Dockerfile' -t ${COMPANY_LOWERCASE}-oauthserver-repository ."
                }
            }
        }
        stage('Build Micro Services') {
            steps {
                echo 'Building ms1'
                dir ('services/'){
                    sh 'dotnet --version'
                    //sh 'dotnet publish Axity.LaAcademia.Api/Axity.LaAcademia.Api.csproj -c Release -o ../app/'
                }
            }
        }
        stage('Sonar Frontend Web') {
            steps {
                dir ('frontend/web/'){
                    //sh '/opt/sonar-scanner/bin/sonar-scanner --version'
                    sh "/opt/sonar-scanner/bin/sonar-scanner \
                        -Dsonar.projectKey=20_${COMPANY}_${PROJECT_NAME}_web_Dev \
                        -Dsonar.sources=src/ \
                        -Dsonar.host.url=${SONAR_SERVER} \
                        -Dsonar.login=${SONAR_TOKEN}"
                }
            }
        }
        stage('Sonar Federated Services') {
            steps { 
                dir ('services/apimanager/'){
                    sh "mvn sonar:sonar \
                        -Dsonar.projectKey=20_${COMPANY}_${PROJECT_NAME}_apimanager_Dev \
                        -Dsonar.projectName=20_${COMPANY}_${PROJECT_NAME}_apimanager_Dev \
                        -Dsonar.sources=src/main \
                        -Dsonar.host.url=${SONAR_SERVER} \
                        -Dsonar.login=${SONAR_TOKEN}"
                }
                dir ('services/oauthserver/'){
                    sh "mvn sonar:sonar \
                        -Dsonar.projectKey=20_${COMPANY}_${PROJECT_NAME}_oauthserver_Dev \
                        -Dsonar.projectName=20_${COMPANY}_${PROJECT_NAME}_oauthserver_Dev \
                        -Dsonar.sources=src/main \
                        -Dsonar.host.url=${SONAR_SERVER} \
                        -Dsonar.login=${SONAR_TOKEN}"
                }
            }
        }
        stage('Sonar Micro Services') {
            steps { 
                dir ('services/'){
                    //sh 'dotnet /opt/sonar-scanner-ms/SonarScanner.MSBuild.dll --version'
                    /*sh '/opt/sonar-runner-2.4/bin/sonar-runner \
                        -Dsonar.projectKey=LaAcademiaAvon_Back_Net \
                        -Dsonar.projectName=LaAcademiaAvon_Back_Net \
                        -Dsonar.sources=. \
                        -Dsonar.host.url=http://devtools.axity.com/sonar7 \
                        -Dsonar.login=e7a8085ab0f60254c49a1a9296e1cc4be0d99c73'*/
                }
            }
        }
        stage('Kubernetes Up') {
            steps {
                echo 'Running Kubernetes'
                sh 'sudo kubectl delete -f deploy_dev.yaml'
                sh 'sudo kubectl apply -f deploy_dev.yaml'
            }
        }
        stage('Database') {
            steps {
                dir ('database/'){
                    sh '/opt/liquibase/liquibase --version'
                    echo 'Applying Db changes'
                }
            }
        }
        stage('Testing Estress') {
            steps {
                dir ('testing/stress/'){
                    echo 'Running Stress Testing'
                }
            }
        }
        stage('Testing UI') {
            steps {
                dir ('testing/ui/'){
                    echo 'Running UI Testing'
                }
            }
        }
    }
    post { 
        always { 
            deleteDir()
            //SlackMsg(currentBuild.currentResult) 
        }
        success {
            echo 'I succeeeded!'
        }
        unstable {
            echo 'I am unstable :/'
        }
        failure {
            echo 'I failed :('
        }
        changed {
            echo 'Things were different before...'
        }
    }
}

def NewPatterName()
{
	return "_" + new Date().format( 'ddMMyyyy' ) + "_" + "${env.BUILD_NUMBER}";
}

def SlackMsg(String buildResult) 
{
	String message = "Compilation result ${env.BUILD_DISPLAY_NAME} for job  \"${env.JOB_NAME}\"  is " + buildResult +  ". For more details got to ${env.JOB_URL}"
	
	if(buildResult == "SUCCESS")
	{
		slackSend color: "good", message: message
	}
	else if(buildResult == "UNSTABLE")
	{ 
		slackSend color: "warning", message: message
	}
	else
	{
		slackSend color: "danger", message: message
	}
}