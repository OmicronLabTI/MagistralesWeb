pipeline {
  agent {
    label 'OmicronDev'
  }
  tools {
    maven 'M3'
    nodejs 'NodeJs12'
  }
  environment {
    //Functions
    DEPLOY_PATTERN = NewPatterName()

    // Projtect configurations
    COMPANY = "Omicron"
    COMPANY_LOWERCASE = "omicron"
    PROJECT_NAME = "AppiOSFormulas"
    PROJECT_NAME_LOWERCASE = "appiosformulas"
    SLACK_CHANNEL = "#omicron_notifications"
    ENVIRONMENT = "Dev"
    NEXUS_REGISTRY = "192.168.0.133:8083"
    REPOSITORY_NAME = "omicrondev"

    // General configurations		
    SONAR_KEY = "20_OMICRONLAB_App-iOS-Formulas_Dev";
    SONAR_SERVER = "https://devtools.axity.com/sonarlts";
    SONAR_TOKEN = "d54f4f0b0ecc98ca94c88640833783fe52216269";
    COMMITER_EMAIL = sh(
      script: 'git --no-pager show -s --format=\'%an - %ae\'',
      returnStdout: true
    ).trim()
  }
  stages {
    stage('Build Front Web') {
      steps {
        echo 'Building Frontend'
        dir('frontend/web/') {
          sh "sudo sed -i \"s/buildEnv/build/g\" Dockerfile"
          script {
            DockerBuildAndPush("web")
          }
        }
      }
    }
    stage('ApiManager') {
      steps {
        dir('services/apimanager/') {
          script {
            DockerBuildAndPush("apimanager")
          }
        }
      }

    }
    stage('Oauth') {
      steps {
        dir('services/oauthserver/') {
          script {
            DockerBuildAndPush("oauthserver")
          }
        }
      }
    }
    stage('Catalogos') {
      steps {
        dir('services/catalogos-service/') {
          script {
            DockerBuildAndPush("catalogos")
          }
        }
      }
    }
    stage('Usuarios') {
      steps {
        dir('services/usuarios-service/') {
          script {
            DockerBuildAndPush("usuarios")
          }
        }
      }
    }
    stage('Pedidos') {
      steps {
        dir('services/pedidos-service/') {
          script {
            DockerBuildAndPush("pedidos")
          }
        }
      }
    }
    stage('SapAdapter') {
      steps {
        dir('services/sapadapter-service/') {
          script {
            DockerBuildAndPush("sapadapter")
          }
        }
      }
    }
    stage('Warehouse') {
      steps {
        dir('services/warehouses-service/') {
          script {
            DockerBuildAndPush("warehouses")
          }
        }
      }
    }
    stage('Reporting') {
      steps {
        dir('services/reporting-service/') {
          script {
            DockerBuildAndPush("reporting")
          }
        }
      }
    }
    stage('KafkaConsumer') {
      steps {
        dir('services/kafkaconsumer-service/') {
          script {
            DockerBuildAndPush("kafkaconsumer")
          }
        }
      }
    }
    // stage('Kubernetes Down') {
    //   steps {
    //     echo 'Running Kubernetes down'
    //     sh 'sudo kubectl delete -f deploy_dev.yaml --grace-period=0 --force --ignore-not-found'
    //     sh 'sudo docker system prune -f'
    //   }
    // }
    // stage('Kubernetes Up') {
    //   steps {
    //     echo 'Running Kubernetes'
    //     sh 'sudo kubectl apply -f deploy_dev.yaml'
    //   }
    // }
    // stage('Database') {
    //   steps {
    //     dir('database/') {
    //       sh '/opt/liquibase/liquibase --version'
    //       sh '/opt/liquibase/liquibase --changeLogFile="changesets/db.changelog-master.xml" update'
    //       echo 'Applying Db changes'
    //     }
    //   }
    // }
    stage('Testing Estress') {
      steps {
        dir('testing/stress/') {
          echo 'Running Stress Testing'
        }
      }
    }
    stage('Testing UI') {
      steps {
        dir('testing/ui/') {
          echo 'Running UI Testing'
        }
      }
    }
  }
  post {
    always {
      deleteDir()
      echo 'Slack'
      SlackMsg(currentBuild.currentResult)
    }
    success {
      echo 'I succeeeded!'
    }
    unstable {
      echo 'I am unstable :/'
    }
    failure {
      echo 'I failed :('
    }
    changed {
      echo 'Things were different before...'
    }
  }
}

def NewPatterName() {
  return "_" + new Date().format('ddMMyyyy') + "_" + "${env.BUILD_NUMBER}";
}

def SlackMsg(String buildResult) {
  String message = "Compilation result ${env.BUILD_DISPLAY_NAME} for job  \"${env.JOB_NAME}\"  is " + buildResult + " launched by ${env.COMMITER_EMAIL}. For more details got to ${env.JOB_URL}"
  echo "${env.BUILD_DISPLAY_NAME}"

  if (buildResult == "SUCCESS") {
    slackSend channel: "${SLACK_CHANNEL}", color: "good", message: message
  } else if (buildResult == "UNSTABLE") {
    slackSend channel: "${SLACK_CHANNEL}", color: "warning", message: message
  } else {
    slackSend channel: "${SLACK_CHANNEL}", color: "danger", message: message
  }
}

def DockerBuildAndPush(entity) {
  def previousBuild = GetPreviousBuild("${REPOSITORY_NAME}/${COMPANY_LOWERCASE}-${PROJECT_NAME_LOWERCASE}-${entity}-repository")
  docker.withRegistry("http://${NEXUS_REGISTRY}", "nexus_omicron") {
    sh "docker pull ${NEXUS_REGISTRY}/${REPOSITORY_NAME}/${COMPANY_LOWERCASE}-${PROJECT_NAME_LOWERCASE}-${entity}-repository:latest || true"
    sh "docker tag ${NEXUS_REGISTRY}/${REPOSITORY_NAME}/${COMPANY_LOWERCASE}-${PROJECT_NAME_LOWERCASE}-${entity}-repository:latest ${NEXUS_REGISTRY}/${REPOSITORY_NAME}/${COMPANY_LOWERCASE}-${PROJECT_NAME_LOWERCASE}-${entity}-repository:0.0.${previousBuild} || true"
    sh "docker push ${NEXUS_REGISTRY}/${REPOSITORY_NAME}/${COMPANY_LOWERCASE}-${PROJECT_NAME_LOWERCASE}-${entity}-repository:0.0.${previousBuild} || true"
    docker.build("${NEXUS_REGISTRY}/${REPOSITORY_NAME}/${COMPANY_LOWERCASE}-${PROJECT_NAME_LOWERCASE}-${entity}-repository:latest", "--build-arg BUILDKIT_INLINE_CACHE=1 --cache-from ${NEXUS_REGISTRY}/${REPOSITORY_NAME}/${COMPANY_LOWERCASE}-${PROJECT_NAME_LOWERCASE}-${entity}-repository:0.0.${previousBuild} .")
    docker.image("${NEXUS_REGISTRY}/${REPOSITORY_NAME}/${COMPANY_LOWERCASE}-${PROJECT_NAME_LOWERCASE}-${entity}-repository:latest").push()
  }
}

def ImageLatestExists(entity) {
  def repo = "${REPOSITORY_NAME}/${COMPANY_LOWERCASE}-${PROJECT_NAME_LOWERCASE}-${entity}-repository"
  try {
    withCredentials([
      [$class: 'UsernamePasswordMultiBinding', credentialsId: 'nexus_omicron', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']
    ]) {
      def res = sh(returnStdout: true, script: "curl -s -H \"Accept: application/json\"  -u ${USERNAME}:${PASSWORD} -X GET http://${NEXUS_REGISTRY}/v2/${repo}/tags/list").trim()
      def json = readJSON text: res
      def tags = json["tags"] as String[]
      return tags.contains("latest")
    }
  } catch (Exception ex) {
    echo "${ex}"
    return false
  }
}

def GetPreviousBuild(repo) {
  try {
    withCredentials([
      [$class: 'UsernamePasswordMultiBinding', credentialsId: 'nexus_omicron', usernameVariable: 'USERNAME', passwordVariable: 'PASSWORD']
    ]) {
      def res = sh(returnStdout: true, script: "curl -s -H \"Accept: application/json\"  -u ${USERNAME}:${PASSWORD} -X GET http://${NEXUS_REGISTRY}/v2/${repo}/tags/list").trim()
      def json = readJSON text: res
      def tags = json["tags"] as String[]
      if (tags.length > 1) {
        def n = tags[tags.length - 2].replaceAll("0.0.", "") as Integer
        return n;
      } else {
        return "${env.BUILD_NUMBER}"
      }
    }
  } catch (Exception ex) {
    echo "${ex}"
    return "${env.BUILD_NUMBER}"
  }
}